/*
 InCHlib - Interactive Cluster Heatmap Library http://openscreen.cz/software/inchlib Copyright 2014, Ctibor ?kuta, Petr Bart?n?k, Daniel Svozil Licensed under the MIT license.

 Permission is hereby granted, free of charge, to any person
 obtaining a copy of this software and associated documentation
 files (the "Software"), to deal in the Software without
 restriction, including without limitation the rights to use,
 copy, modify, merge, publish, distribute, sublicense, and/or sell
 copies of the Software, and to permit persons to whom the
 Software is furnished to do so, subject to the following
 conditions:

 The above copyright notice and this permission notice shall be
 included in all copies or substantial portions of the Software.

 THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
 EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES
 OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
 NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT
 HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,
 WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
 FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
 OTHER DEALINGS IN THE SOFTWARE.

 @requires <a href='http://code.jquery.com/jquery-2.0.3.min.js'>jQuery Core 2.0.3</a>
 @dependency <script language="JavaScript" type="text/javascript" src="http://code.jquery.com/jquery-2.0.3.min.js"></script>

 @requires <a href='http://kineticjs.com/'>KineticJS 5.1.0</a>
 @dependency <script language="JavaScript" type="text/javascript" src="http://openscreen.cz/software/inchlib/static/js/kinetic-v5.1.0.min.js"></script>

 @param {Object} options An object with the options for the InCHlib component.

 @option {string} target
   identifier of the DIV tag where the component should be displayed

 @option {boolean} [column_dendrogram=false]
   turn on/off the column dendrogram

 @option {boolean} [count_column=false]
   turn on/off the count column

 @option {boolean} [dendrogram=true]
   turn on/off the row dendrogram

 @option {string} [font="Trebuchet&nbsp;MS"]
   font family

 @option {string} [heatmap_colors="Greens"]
   the heatmap color scale

 @option {number} [heatmap_part_width=0.7]
   define the heatmap part width from the width of the whole graph

 @option {string} [highlight_colors="Reds"]
   color scale for highlighted rows

 @option {obejct} [highlighted_rows=[]]
   array of row IDs to highlight

 @option {boolean} [independent_columns=true]
   determines whether the color scale is based on the values from all columns together or for each column separately

 @option {string} [label_color=grey]
   color of column label

 @option {number} [max_column_width=100]
   maximum column width in pixels

 @option {number} [max_height=800]
   maximum graph height in pixels

 @option {number} [max_row_height=25]
   maximum row height in pixels

 @option {boolean} [metadata=false]
   turn on/off the metadata

 @option {string} [metadata_colors="Oranges"]
   the metadata color scale

 @option {number} [min_row_height=false]
   minimum row height in pixels

 @option {number} [width="the width of target DIV"]
   width of the graph in pixels

 @option {boolean} [heatmap=true]
   turn on/off the heatmap

 @option {string} [heatmap_font_color="black"]
   the color of the text values in the heatmap

 @option {string} [count_column_colors="Reds"]
   the color scale of count column

 @option {boolean} [draw_row_ids=false]
   draws the row IDs next to the heatmap when there is enough space to visualize them

 @option {boolean} [fixed_row_id_size=false]
   fixes the row id size on given number and extends the right margin of the visualization accordingly

 @option {number} [max_percentile=100]
   the value percentile above which the color will be equal to the terminal color of the color scale

 @option {number} [min_percentile=0]
   the value percentile below which the color will be equal to the beginning color of the color scale

 @option {number} [middle_percentile=50]
   the value percentile which defines where the middle color of the color scale will be used

 @option {array} [columns_order=[]]
   the order of columns defined by their indexes startin from 0, when not provided the columns are sorted in common order 0, 1, 2... etc.

 @option {boolean} [alternative_data=false]
   use original data to compute heatmap but show the alternative values (alternative_data section must be present in input data)

 @option {boolean} [images_as_alternative_data=false]
   alternative data values can be used to identify image files (.png, .jpg) and draw them insted of the heatmap values

 @option {object} [images_path=false]
   when using images_as_alternative_data option - set dir path of the image files and the image files extension to generate the whole file path ({"dir": "", "ext": ""})

 @option {object} [navigation_toggle={"distance_scale": false, "filter_button": false, "export_button": false, "color_scale": false, "hint_button": false}]
   toggle "navigation" features - true/false


 @example
       window.instance = new InCHlib({
                target : "YourOwnDivId",
                metadata: true,
                max_height: 800,
                width: 700,
                metadata_colors: "RdLrBu"
            });
       instance.read_data_from_file("../biojs/data/chembl_gr.json");
       instance.draw();
*/
var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(f,a,b){f!=Array.prototype&&f!=Object.prototype&&(f[a]=b.value)};$jscomp.getGlobal=function(f){return"undefined"!=typeof window&&window===f?f:"undefined"!=typeof global&&null!=global?global:f};$jscomp.global=$jscomp.getGlobal(this);$jscomp.SYMBOL_PREFIX="jscomp_symbol_";
$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol)};$jscomp.Symbol=function(){var f=0;return function(a){return $jscomp.SYMBOL_PREFIX+(a||"")+f++}}();
$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var f=$jscomp.global.Symbol.iterator;f||(f=$jscomp.global.Symbol.iterator=$jscomp.global.Symbol("iterator"));"function"!=typeof Array.prototype[f]&&$jscomp.defineProperty(Array.prototype,f,{configurable:!0,writable:!0,value:function(){return $jscomp.arrayIterator(this)}});$jscomp.initSymbolIterator=function(){}};$jscomp.arrayIterator=function(f){var a=0;return $jscomp.iteratorPrototype(function(){return a<f.length?{done:!1,value:f[a++]}:{done:!0}})};
$jscomp.iteratorPrototype=function(f){$jscomp.initSymbolIterator();f={next:f};f[$jscomp.global.Symbol.iterator]=function(){return this};return f};$jscomp.iteratorFromArray=function(f,a){$jscomp.initSymbolIterator();f instanceof String&&(f+="");var b=0,c={next:function(){if(b<f.length){var d=b++;return{value:a(d,f[d]),done:!1}}c.next=function(){return{done:!0,value:void 0}};return c.next()}};c[Symbol.iterator]=function(){return c};return c};
$jscomp.polyfill=function(f,a,b,c){if(a){b=$jscomp.global;f=f.split(".");for(c=0;c<f.length-1;c++){var d=f[c];d in b||(b[d]={});b=b[d]}f=f[f.length-1];c=b[f];a=a(c);a!=c&&null!=a&&$jscomp.defineProperty(b,f,{configurable:!0,writable:!0,value:a})}};$jscomp.polyfill("Array.prototype.keys",function(f){return f?f:function(){return $jscomp.iteratorFromArray(this,function(a){return a})}},"es6","es3");
$jscomp.findInternal=function(f,a,b){f instanceof String&&(f=String(f));for(var c=f.length,d=0;d<c;d++){var e=f[d];if(a.call(b,e,d,f))return{i:d,v:e}}return{i:-1,v:void 0}};$jscomp.polyfill("Array.prototype.find",function(f){return f?f:function(a,b){return $jscomp.findInternal(this,a,b).v}},"es6","es3");var InCHlib;
(function(f){InCHlib=function(a){this.user_settings=a;this.target_element=f("#"+a.target);var b=this.target_element.width();this.target_element.css({position:"relative"});this.settings={target:"YourOwnDivId",heatmap:!0,heatmap_header:!0,dendrogram:!0,metadata:!1,column_metadata:!1,column_metadata_row_height:8,column_metadata_colors:"RdLrBu",max_height:800,width:b,heatmap_colors:"Greens",heatmap_font_color:"black",heatmap_part_width:.7,column_dendrogram:!1,independent_columns:!0,metadata_colors:"Reds",
highlight_colors:"Oranges",highlighted_rows:[],label_color:"#9E9E9E",count_column:!1,count_column_colors:"Reds",min_row_height:1,max_row_height:25,max_column_width:150,font:"Helvetica",draw_row_ids:!1,fixed_row_id_size:!1,max_percentile:100,min_percentile:0,middle_percentile:50,columns_order:[],alternative_data:!1,images_as_alternative_data:!1,images_path:{dir:"",ext:""},navigation_toggle:{color_scale:!0,distance_scale:!0,export_button:!0,filter_button:!0,hint_button:!0}};this.update_settings(a);
this.settings.width=a.max_width&&a.max_width<b?a.max_width:this.settings.width;this.settings.heatmap_part_width=.9<this.settings.heatmap_part_width?.9:this.settings.heatmap_part_width;this.header_height=150;this.footer_height=70;this.dendrogram_heatmap_distance=5;this.events={row_onclick:function(a,b){},row_onmouseover:function(a,b){},row_onmouseout:function(a){},dendrogram_node_onclick:function(a,b,e){},column_dendrogram_node_onclick:function(a,b,e){},dendrogram_node_highlight:function(a,b){},column_dendrogram_node_highlight:function(a,
b){},dendrogram_node_unhighlight:function(a){},column_dendrogram_node_unhighlight:function(a){},heatmap_onmouseout:function(a){},on_zoom:function(a,b){},on_unzoom:function(a){},on_columns_zoom:function(a,b){},on_columns_unzoom:function(a){},on_refresh:function(){},empty_space_onclick:function(a){},on_redraw_heatmap:function(){}};this.colors={YlGn:{start:{r:255,g:255,b:204},end:{r:35,g:132,b:67}},GnBu:{start:{r:240,g:249,b:232},end:{r:43,g:140,b:190}},BuGn:{start:{r:237,g:248,b:251},end:{r:35,g:139,
b:69}},PuBu:{start:{r:241,g:238,b:246},end:{r:5,g:112,b:176}},BuPu:{start:{r:237,g:248,b:251},end:{r:136,g:65,b:157}},RdPu:{start:{r:254,g:235,b:226},end:{r:174,g:1,b:126}},PuRd:{start:{r:241,g:238,b:246},end:{r:206,g:18,b:86}},OrRd:{start:{r:254,g:240,b:217},end:{r:215,g:48,b:31}},Purples2:{start:{r:242,g:240,b:247},end:{r:106,g:81,b:163}},Blues:{start:{r:239,g:243,b:255},end:{r:33,g:113,b:181}},Greens:{start:{r:237,g:248,b:233},end:{r:35,g:139,b:69}},Oranges:{start:{r:254,g:237,b:222},end:{r:217,
g:71,b:1}},Reds:{start:{r:254,g:229,b:217},end:{r:203,g:24,b:29}},Greys:{start:{r:247,g:247,b:247},end:{r:82,g:82,b:82}},PuOr:{start:{r:230,g:97,b:1},end:{r:94,g:60,b:153}},BrBG:{start:{r:166,g:97,b:26},end:{r:1,g:133,b:113}},RdBu:{start:{r:202,g:0,b:32},end:{r:5,g:113,b:176}},RdGy:{start:{r:202,g:0,b:32},end:{r:64,g:64,b:64}},BuYl:{start:{r:5,g:113,b:176},end:{r:250,g:233,b:42}},YlOrR:{start:{r:255,g:255,b:178},end:{r:227,g:26,b:28},middle:{r:204,g:76,b:2}},YlOrB:{start:{r:255,g:255,b:212},end:{r:5,
g:112,b:176},middle:{r:204,g:76,b:2}},Y2OrB:{start:{r:255,g:191,b:12},end:{r:5,g:112,b:176},middle:{r:204,g:76,b:2}},G2OrB:{start:{r:77,g:172,b:38},end:{r:5,g:112,b:176},middle:{r:204,g:76,b:2}},PRGn2:{start:{r:123,g:50,b:148},end:{r:0,g:136,b:55},middle:{r:202,g:0,b:32}},PiYG2:{start:{r:208,g:28,b:139},end:{r:77,g:172,b:38},middle:{r:255,g:255,b:178}},YlGnBu:{start:{r:255,g:255,b:204},end:{r:34,g:94,b:168},middle:{r:35,g:132,b:67}},RdYlBu:{start:{r:215,g:25,b:28},end:{r:44,g:123,b:182},middle:{r:255,
g:255,b:178}},RdYlGn:{start:{r:215,g:25,b:28},end:{r:26,g:150,b:65},middle:{r:255,g:255,b:178}},BuWhRd:{start:{r:33,g:113,b:181},middle:{r:255,g:255,b:255},end:{r:215,g:25,b:28}},RdLrBu:{start:{r:215,g:25,b:28},middle:{r:254,g:229,b:217},end:{r:44,g:123,b:182}},RdBkGr:{start:{r:215,g:25,b:28},middle:{r:0,g:0,b:0},end:{r:35,g:139,b:69}},RdLrGr:{start:{r:215,g:25,b:28},middle:{r:254,g:229,b:217},end:{r:35,g:139,b:69}}};this.objects_ref={tooltip_label:new Kinetic.Label({opacity:1,listening:!1}),tooltip_tag:new Kinetic.Tag({fill:this.settings.label_color,
pointerWidth:10,pointerHeight:10,lineJoin:"round",listening:!1}),tooltip_text:new Kinetic.Text({fontFamily:this.settings.font,fontSize:12,padding:8,fill:"white",fontStyle:"bold",listening:!1,align:"center",lineHeight:1.2}),node:new Kinetic.Line({stroke:"grey",strokeWidth:2,lineCap:"sqare",lineJoin:"round",listening:!1}),node_rect:new Kinetic.Rect({fill:"white",opacity:0}),icon_overlay:new Kinetic.Rect({width:32,height:32,opacity:0}),heatmap_value:new Kinetic.Text({fontFamily:this.settings.font,fill:this.settings.heatmap_font_color,
fontStyle:"bold",listening:!1}),heatmap_line:new Kinetic.Line({lineCap:"butt",value:!1}),column_header:new Kinetic.Text({fontFamily:this.settings.font,fontStyle:"bold",fill:"black"}),count:new Kinetic.Text({fontSize:10,fill:"#6d6b6a",fontFamily:this.settings.font,fontStyle:"bold",listening:!1}),cluster_overlay:new Kinetic.Rect({fill:"white",opacity:.5}),cluster_border:new Kinetic.Line({stroke:"black",strokeWidth:1,dash:[6,2]}),icon:new Kinetic.Path({fill:"grey"}),rect_gradient:new Kinetic.Rect({x:0,
y:80,width:100,height:20,fillLinearGradientStartPoint:{x:0,y:80},fillLinearGradientEndPoint:{x:100,y:80},stroke:"#D2D2D2",strokeWidth:"1px"}),image:new Kinetic.Image({stroke:"#D2D2D2",strokeWidth:1}),legend_icon:new Kinetic.Rect({x:this.settings.width,y:this.header_height,width:8,height:8,fill:"red",stroke:"black",strokeWidth:"2px"})};this.paths_ref={zoom_icon:"M22.646,19.307c0.96-1.583,1.523-3.435,1.524-5.421C24.169,8.093,19.478,3.401,13.688,3.399C7.897,3.401,3.204,8.093,3.204,13.885c0,5.789,4.693,10.481,10.484,10.481c1.987,0,3.839-0.563,5.422-1.523l7.128,7.127l3.535-3.537L22.646,19.307zM13.688,20.369c-3.582-0.008-6.478-2.904-6.484-6.484c0.006-3.582,2.903-6.478,6.484-6.486c3.579,0.008,6.478,2.904,6.484,6.486C20.165,17.465,17.267,20.361,13.688,20.369zM15.687,9.051h-4v2.833H8.854v4.001h2.833v2.833h4v-2.834h2.832v-3.999h-2.833V9.051z",
unzoom_icon:"M22.646,19.307c0.96-1.583,1.523-3.435,1.524-5.421C24.169,8.093,19.478,3.401,13.688,3.399C7.897,3.401,3.204,8.093,3.204,13.885c0,5.789,4.693,10.481,10.484,10.481c1.987,0,3.839-0.563,5.422-1.523l7.128,7.127l3.535-3.537L22.646,19.307zM13.688,20.369c-3.582-0.008-6.478-2.904-6.484-6.484c0.006-3.582,2.903-6.478,6.484-6.486c3.579,0.008,6.478,2.904,6.484,6.486C20.165,17.465,17.267,20.361,13.688,20.369zM8.854,11.884v4.001l9.665-0.001v-3.999L8.854,11.884z",lightbulb:"M15.5,2.833c-3.866,0-7,3.134-7,7c0,3.859,3.945,4.937,4.223,9.499h5.553c0.278-4.562,4.224-5.639,4.224-9.499C22.5,5.968,19.366,2.833,15.5,2.833zM15.5,28.166c1.894,0,2.483-1.027,2.667-1.666h-5.334C13.017,27.139,13.606,28.166,15.5,28.166zM12.75,25.498h5.5v-5.164h-5.5V25.498z"}};
InCHlib.prototype._update_user_settings=function(a){for(var b={},c,d=0,e=Object.keys(a),g=e.length;d<g;d++)c=e[d],void 0!==this.user_settings[c]&&this.user_settings[c]!==a[c]&&!0===this.user_settings[c]?b[c]=!1:void 0===this.user_settings[c]&&(b[c]=a[c]);f.extend(this.settings,b)};InCHlib.prototype.read_data=function(a){this.json=a;this.data=this.json.data;var b={};void 0!==a.metadata?(this.metadata=a.metadata,b.metadata=!0):b.metadata=!1;void 0!==a.column_dendrogram?(this.column_dendrogram=a.column_dendrogram,
b.column_dendrogram=!0):b.column_dendrogram=!1;void 0!==a.column_metadata?(this.column_metadata=a.column_metadata,b.column_metadata=!0):b.column_metadata=!1;void 0!==this.json.alternative_data&&this.settings.alternative_data?this.alternative_data=this.json.alternative_data.nodes:b.alternative_data=!1;this._update_user_settings(b);this._add_prefix()};InCHlib.prototype.read_data_from_file=function(a){var b=this;f.ajax({type:"GET",url:a,dataType:"json",success:function(a){b.read_data(a)},async:!1})};
InCHlib.prototype._add_prefix=function(){this.data.nodes=this._add_prefix_to_data(this.data.nodes);if(this.settings.metadata){for(var a={},b=0,c=Object.keys(this.metadata.nodes),d=c.length;b<d;b++)id=[this.settings.target,c[b]].join("#"),a[id]=this.metadata.nodes[c[b]];this.metadata.nodes=a}if(this.settings.alternative_data){a={};b=0;c=Object.keys(this.alternative_data);for(d=c.length;b<d;b++)id=[this.settings.target,c[b]].join("#"),a[id]=this.alternative_data[c[b]];this.alternative_data=a}this.column_dendrogram&&
(this.column_dendrogram.nodes=this._add_prefix_to_data(this.column_dendrogram.nodes))};InCHlib.prototype._add_prefix_to_data=function(a){for(var b,c={},d=0,e=Object.keys(a),g=e.length;d<g;d++)b=[this.settings.target,e[d]].join("#"),c[b]=a[e[d]],void 0!==c[b].parent&&(c[b].parent=[this.settings.target,c[b].parent].join("#")),1!=c[b].count&&(c[b].left_child=[this.settings.target,c[b].left_child].join("#"),c[b].right_child=[this.settings.target,c[b].right_child].join("#"));return c};InCHlib.prototype._get_root_id=
function(a){for(var b,c=0,d=Object.keys(a),e=d.length;c<e;c++)if(void 0===a[d[c]].parent){b=d[c];break}return b};InCHlib.prototype._get_dimensions=function(){var a={data:0,metadata:0,overall:0};if(this.settings.images_as_alternative_data)a.data=this.alternative_data[Object.keys(this.alternative_data)[0]].length;else{var b=0;var c=Object.keys(this.data.nodes);for(len=c.length;b<len;b++){var d=c[b];if(1==this.data.nodes[d].count){a.data=this.data.nodes[d].features.length;break}}}this.settings.metadata&&
(d=Object.keys(this.metadata.nodes)[0],a.metadata=this.metadata.nodes[d].length);a.overall=a.data+a.metadata;return a};InCHlib.prototype._get_min_max_middle=function(a){var b,c=[],d=[];var e=0;for(b=a.length;e<b;e++)d=d.concat(a[e].filter(function(a){return null!==a}));b=d.length;d.sort(function(a,b){return a-b});c.push(0<this.settings.min_percentile?d[this._hack_round(b*this.settings.min_percentile/100)]:d[0]);c.push(100>this.settings.max_percentile?d[this._hack_round(b*this.settings.max_percentile/
100)]:d[b-1]);c.push(50!=this.settings.middle_percentile?d[this._hack_round(b*this.settings.middle_percentile/100)]:d[this._hack_round((b-1)/2)]);return c};InCHlib.prototype._get_data_min_max_middle=function(a,b){void 0===b&&(b="column");var c,d=a[0].length;if("column"==b){var e=[];for(b=0;b<d;b++)e.push([]);for(b=0;b<a.length;b++)for(c=0;c<d;c++){var g=a[b][c];null!==g&&void 0!==g&&e[c].push(g)}}else e=a.slice(0);a={};for(b=0;b<e.length;b++)if(this._is_number(e[b][0]))e[b]=e[b].map(parseFloat).filter(function(a){return!isNaN(a)}),
e[b].sort(function(a,b){return a-b}),g=e[b].length,c=100>this.settings.max_percentile?e[b][this._hack_round(g*this.settings.max_percentile/100)]:e[b][g-1],d=0<this.settings.min_percentile?e[b][this._hack_round(g*this.settings.min_percentile/100)]:e[b][0],g=50!=this.settings.middle_percentile?e[b][this._hack_round(g*this.settings.middle_percentile/100)]:e[b][this._hack_round((g-1)/2)],a[b]={min:d,max:c,middle:g};else{var h=this._get_hash_object(e[b]);d=0;c=this._hack_size(h)-1;g=c/2;a[b]={min:d,max:c,
middle:g,str2num:h}}return a};InCHlib.prototype._get_hash_object=function(a){var b,c=0,d={};a=a.slice(0).filter(function(a){return"NA"!=a});a.sort();for(b=0;b<a.length;b++)void 0===d[a[b]]&&(d[a[b]]=c,c++);return d};InCHlib.prototype._get_max_length=function(a){a=a.map(function(a){return(""+a).length});return Math.max.apply(Math,a)};InCHlib.prototype._get_max_value_length=function(){var a=this.data.nodes,b=0;if(this.settings.alternative_data)if(this.settings.images_as_alternative_data)b=0;else for(var c=
0,d=Object.keys(this.alternative_data),e=d.length;c<e;c++){var g=d[c];g=this.alternative_data[g];for(var h=0,f=g.length;h<f;h++)(""+g[h]).length>b&&(b=(""+g[h]).length)}else for(c=0,d=Object.keys(a),e=d.length;c<e;c++)if(g=d[c],1==a[g].count)for(g=a[g].features,h=0,f=g.length;h<f;h++)(""+g[h]).length>b&&(b=(""+g[h]).length);if(this.settings.metadata)for(a=this.metadata.nodes,c=0,d=Object.keys(a),e=d.length;c<e;c++)for(g=d[c],g=a[g],h=0,f=g.length;h<f;h++)(""+g[h]).length>b&&(b=(""+g[h]).length);return b};
InCHlib.prototype._preprocess_heatmap_data=function(){var a=[],b=0,c;var d=0;var e=Object.keys(this.data.nodes);for(c=e.length;d<c;d++){var g=e[d];var h=this.data.nodes[g];1==h.count&&(h=h.features,a.push([g]),a[b].push.apply(a[b],h),this.settings.metadata&&a[b].push.apply(a[b],this.metadata.nodes[g]),b++)}return a};InCHlib.prototype._reorder_heatmap=function(a){this.leaves_y_coordinates={};a++;this.ordered_by_index==a?this.heatmap_array.reverse():this._is_number(this.heatmap_array[0][a])?this.heatmap_array.sort(function(b,
c){return null==b[a]?-1:null==c[a]?1:b[a]-c[a]}):this.heatmap_array.sort(function(b,c){return null==b[a]?-1:null==c[a]?1:b[a]>c[a]?1:b[a]<c[a]?-1:0});for(var b=this.pixels_for_leaf/2+this.header_height,c=0,d=this.heatmap_array.length;c<d;c++)this.leaves_y_coordinates[this.heatmap_array[c][0]]=b,b+=this.pixels_for_leaf;this.ordered_by_index=a};InCHlib.prototype.draw=function(){this.zoomed_clusters={row:[],column:[]};this.last_highlighted_cluster=null;this.current_object_ids=[];this.current_column_ids=
[];this.highlighted_rows_y=[];this.heatmap_array=this._preprocess_heatmap_data();this.on_features={data:[],metadata:[],count_column:[]};this.column_metadata_rows=this.settings.column_metadata?this.column_metadata.features.length:0;this.column_metadata_height=this.column_metadata_rows*this.settings.column_metadata_row_height;this.settings.heatmap?(this.last_column=null,this.dimensions=this._get_dimensions(),this._set_heatmap_settings()):(this.dimensions={data:0,metadata:0,overall:0},this.settings.heatmap_header=
!1,this.settings.column_dendrogram=!1);this._adjust_leaf_size(this.heatmap_array.length);this.settings.draw_row_ids?this._get_row_id_size():this.right_margin=100;this._adjust_horizontal_sizes();this.top_heatmap_distance=this.header_height+this.column_metadata_height+this.dendrogram_heatmap_distance;this.heatmap_header&&(this.footer_height=150);this.stage=new Kinetic.Stage({container:this.settings.target});this.settings.height=this.heatmap_array.length*this.pixels_for_leaf+this.header_height+this.footer_height;
this.stage.setWidth(this.settings.width+this.settings.legend_area_width);this.stage.setHeight(this.settings.height>this.settings.min_height?this.settings.height:this.settings.min_height);this._draw_stage_layer();this.settings.dendrogram?(this.timer=0,this._draw_dendrogram_layers(),this.root_id=this._get_root_id(this.data.nodes),this._draw_row_dendrogram(this.root_id),this.settings.column_dendrogram&&this.settings.dendrogram&&(this.column_root_id=this._get_root_id(this.column_dendrogram.nodes),this.nodes2columns=
!1,this.columns_start_index=0,this._draw_column_dendrogram(this.column_root_id))):(this.settings.column_dendrogram=!1,this._reorder_heatmap(0),this.ordered_by_index=0);this.settings.images_as_alternative_data&&(this.path2image={},this.path2image_obj={},this.image_counter=0);this._draw_heatmap();this._draw_heatmap_header();this._draw_navigation();this.highlight_rows(this.settings.highlighted_rows)};InCHlib.prototype._draw_dendrogram_layers=function(){var a=this;a.cluster_layer=new Kinetic.Layer;a.dendrogram_hover_layer=
new Kinetic.Layer;a.stage.add(a.cluster_layer,a.dendrogram_hover_layer);a.cluster_layer.on("click",function(b){a.unhighlight_cluster();a.unhighlight_column_cluster();a.events.empty_space_onclick(b)})};InCHlib.prototype._draw_row_dendrogram=function(a){var b=this;b.dendrogram_layer=new Kinetic.Layer;var c=b.data.nodes[a],d=c.count;b.distance_step=b.distance/c.distance;b.leaves_y_coordinates={};b.objects2leaves={};b._adjust_leaf_size(d);b.settings.height=d*b.pixels_for_leaf+b.header_height+b.footer_height+
b.column_metadata_height;b.stage.setWidth(b.settings.width+b.settings.legend_area_width);b.stage.setHeight(b.settings.height>b.settings.min_height?b.settings.height:b.settings.min_height);var e=d=0,g=b.header_height+b.column_metadata_height+b.pixels_for_leaf/2;1<c.count&&(d=b.data.nodes[c.left_child].count,e=b.data.nodes[c.right_child].count);b._draw_row_dendrogram_node(a,c,d,e,0,g);b.middle_item_count=(b.min_item_count+b.max_item_count)/2;b._draw_distance_scale(c.distance);b.stage.add(b.dendrogram_layer);
b._bind_dendrogram_hover_events(b.dendrogram_layer);b.dendrogram_layer.on("click",function(a){b._dendrogram_layers_click(this,a)});b.dendrogram_layer.on("mousedown",function(a){b._dendrogram_layers_mousedown(this,a)});b.dendrogram_layer.on("mouseup",function(a){b._dendrogram_layers_mouseup(this,a)})};InCHlib.prototype._draw_row_dendrogram_node=function(a,b,c,d,e,g){if(1!=b.count){g=this._get_node_neighbourhood(b,this.data.nodes);e=this.data.nodes[b.right_child];var h=this.data.nodes[b.left_child],
f=this._get_y1(g,c,d),k=this._get_y2(g,c,d),l=this._hack_round(this.distance-this.distance_step*b.distance);l=0==l?2:l;var m=this.distance-this.distance_step*this.data.nodes[b.left_child].distance,q=this.distance-this.distance_step*this.data.nodes[b.right_child].distance;1==e.count&&(k+=this.pixels_for_leaf/2);this.dendrogram_layer.add(this._draw_horizontal_path(a,l,f,l,k,m,q));this._draw_row_dendrogram_node(b.left_child,h,c-g.left_node.right_count,d+g.left_node.right_count,m,f);this._draw_row_dendrogram_node(b.right_child,
e,c+g.right_node.left_count,d-g.right_node.left_count,q,k)}else{c=b.objects;this.leaves_y_coordinates[a]=g;d=0;for(g=c.length;d<g;d++)this.objects2leaves[c[d]]=a;a=b.objects.length;a<this.min_item_count&&(this.min_item_count=a);a>this.max_item_count&&(this.max_item_count=a)}};InCHlib.prototype._draw_stage_layer=function(){var a=this;a.stage_layer=new Kinetic.Layer;var b=new Kinetic.Rect({x:0,y:0,width:a.settings.width+a.settings.legend_area_width,height:a.settings.height>a.settings.min_height?a.settings.height:
a.settings.min_height,opacity:0});a.stage_layer.add(b);b.moveToBottom();a.stage.add(a.stage_layer);a.stage_layer.on("click",function(b){a.unhighlight_cluster();a.unhighlight_column_cluster();a.events.empty_space_onclick(b)})};InCHlib.prototype._draw_column_dendrogram=function(a){var b=this;b.column_dendrogram_layer=new Kinetic.Layer;b.column_x_coordinates={};var c=b.column_dendrogram.nodes[a];b.current_column_count=c.count;b.vertical_distance=b.header_height;b.vertical_distance_step=b.vertical_distance/
c.distance;b.last_highlighted_column_cluster=null;b._draw_column_dendrogram_node(a,c,b.column_dendrogram.nodes[c.left_child].count,b.column_dendrogram.nodes[c.right_child].count,0,0);b.stage.add(b.column_dendrogram_layer);b.nodes2columns||(b.nodes2columns=b._get_nodes2columns());b._bind_dendrogram_hover_events(b.column_dendrogram_layer);b.column_dendrogram_layer.on("click",function(a){b._column_dendrogram_layers_click(this,a)});b.column_dendrogram_layer.on("mousedown",function(a){b._column_dendrogram_layers_mousedown(this,
a)});b.column_dendrogram_layer.on("mouseup",function(a){b._dendrogram_layers_mouseup(this,a)})};InCHlib.prototype._get_nodes2columns=function(){var a=[],b={},c={};var d=0;keys=Object.keys(this.column_x_coordinates);for(len=keys.length;d<len;d++){var e=keys[d];var g=this.column_x_coordinates[e];b[g]=e;a.push(g)}a.sort(function(a,b){return a-b});d=0;for(len=a.length;d<len;d++)c[b[a[d]]]=d;return c};InCHlib.prototype._bind_dendrogram_hover_events=function(a){var b=this;a.on("mouseover",function(a){b._dendrogram_layers_mouseover(this,
a)});a.on("mouseout",function(a){b._dendrogram_layers_mouseout(this,a)})};InCHlib.prototype._delete_layers=function(a,b){for(var c=0,d=a.length;c<d;c++)void 0!==a[c]&&a[c].destroy();if(void 0!==b)for(c=0,d=b.length;c<d;c++)b[c].removeChildren(),b[c].draw()};InCHlib.prototype._delete_all_layers=function(){this.stage.destroyChildren()};InCHlib.prototype._adjust_leaf_size=function(a){this.pixels_for_leaf=(this.settings.max_height-this.header_height-this.footer_height-this.column_metadata_height-this.dendrogram_heatmap_distance)/
a;this.settings.draw_row_ids&&this.settings.fixed_row_id_size&&(this.settings.min_row_height=this.settings.fixed_row_id_size+2);this.pixels_for_leaf>this.settings.max_row_height&&(this.pixels_for_leaf=this.settings.max_row_height);this.settings.min_row_height>this.pixels_for_leaf&&(this.pixels_for_leaf=this.settings.min_row_height)};InCHlib.prototype._adjust_horizontal_sizes=function(a){void 0===a&&(a=this._get_visible_count());this.settings.dendrogram?(this.heatmap_width=this.settings.heatmap?(this.settings.width-
this.right_margin-this.dendrogram_heatmap_distance)*this.settings.heatmap_part_width:0,this.pixels_for_dimension=0<a&&0<this.heatmap_width?this.heatmap_width/a:0,0===this.pixels_for_dimension&&(this.heatmap_width=0),this.distance=this.settings.width-this.heatmap_width-this.right_margin,this.heatmap_distance=this.distance+this.dendrogram_heatmap_distance):(this.heatmap_width=this.settings.width-this.right_margin,this.heatmap_distance=this.distance=this.right_margin/2,this.pixels_for_dimension=a?this.heatmap_width/
a:0);this.settings.max_column_width&&this.settings.max_column_width<this.pixels_for_dimension&&(this.pixels_for_dimension=this.settings.max_column_width,this.heatmap_width=a*this.pixels_for_dimension,this.settings.dendrogram?(this.distance=this.settings.width-this.heatmap_width-this.right_margin-this.dendrogram_heatmap_distance,this.heatmap_distance=this.distance+this.dendrogram_heatmap_distance):this.heatmap_distance=this.right_margin=this.distance=this._hack_round((this.settings.width-this.heatmap_width)/
2))};InCHlib.prototype._set_color_settings=function(){var a=[];i=0;keys=Object.keys(this.data.nodes);for(len=keys.length;i<len;i++)node=this.data.nodes[keys[i]],1==node.count&&a.push(node.features);this.data_descs={};if(this.settings.independent_columns)this.data_descs=this._get_data_min_max_middle(a);else for(a=this._get_min_max_middle(a),i=0;i<this.dimensions.data;i++)this.data_descs[i]={min:a[0],max:a[1],middle:a[2]};if(this.settings.metadata){a=[];i=0;keys=Object.keys(this.metadata.nodes);for(len=
keys.length;i<len;i++)a.push(this.metadata.nodes[keys[i]]);this.metadata_descs=this._get_data_min_max_middle(a)}};InCHlib.prototype._set_heatmap_settings=function(){var a;this.header=[];for(a=0;a<this.dimensions.overall;a++)this.header.push("");if(0===this.settings.columns_order.length||this.settings.columns_order.length!==this.dimensions.data)for(this.settings.columns_order=[],a=0;a<this.dimensions.data;a++)this.settings.columns_order.push(a);if(this.settings.metadata)for(a=this.dimensions.data;a<
this.dimensions.data+this.dimensions.metadata;a++)this.settings.columns_order.push(a);this.settings.count_column&&this.settings.columns_order.push(this.settings.columns_order.length);this.features={};for(a=0;a<this.settings.columns_order.length;a++)this.features[a]=!0;this._set_on_features();this.metadata_header=this.heatmap_header=!1;this.current_label=null;this._set_color_settings();this.settings.alternative_data&&void 0!==this.json.alternative_data.feature_names?this.heatmap_header=this.json.alternative_data.feature_names:
void 0!==this.data.feature_names&&(this.heatmap_header=this.data.feature_names);if(this.heatmap_header)for(a=0;a<this.dimensions.data;a++)this.header[a]=this.heatmap_header[this.on_features.data[a]];if(this.settings.metadata&&this.metadata.feature_names)for(this.metadata_header=this.metadata.feature_names,a=0;a<this.dimensions.metadata;a++)this.header[this.dimensions.data+a]=this.metadata_header[a];this.settings.column_metadata&&void 0!==this.column_metadata.feature_names&&(this.column_metadata_header=
this.column_metadata.feature_names);this.settings.count_column&&(this.min_item_count=this.max_item_count=1,this.dimensions.overall++,this.header.push("Count"));this._adjust_horizontal_sizes();this.top_heatmap_distance=this.header_height+this.column_metadata_height+this.dendrogram_heatmap_distance};InCHlib.prototype._set_on_features=function(a){if(void 0===a){a=[];for(var b=0,c=Object.keys(this.features),d=c.length;b<d;b++){var e=c[b];this.features[e]&&a.push(this.settings.columns_order[b])}}this.on_features=
{data:[],metadata:[],count_column:[]};b=0;for(d=a.length;b<d;b++)e=a[b],e<this.dimensions.data?this.on_features.data.push(e):e<=this.dimensions.data+this.dimensions.metadata-1?this.on_features.metadata.push(e-this.dimensions.data):this.on_features.count_column.push(0)};InCHlib.prototype._draw_heatmap=function(){var a=this;if(a.settings.heatmap){a.heatmap_layer=new Kinetic.Layer;a.heatmap_overlay=new Kinetic.Layer;a.current_draw_values=!0;a.max_value_length=a._get_max_value_length();a.value_font_size=
a._get_font_size(a.max_value_length,a.pixels_for_dimension,a.pixels_for_leaf,12);4>a.value_font_size&&(a.current_draw_values=!1);for(var b=a.heatmap_distance,c=0,d=Object.keys(a.leaves_y_coordinates),e=d.length;c<e;c++){key=d[c];var g=a.leaves_y_coordinates[key];g=a._draw_heatmap_row(key,b,g);a.heatmap_layer.add(g);a._bind_row_events(g)}a.highlighted_rows_layer=new Kinetic.Layer;a.stage.add(a.heatmap_layer,a.heatmap_overlay,a.highlighted_rows_layer);a.highlighted_rows_layer.moveToTop();a.row_overlay=
a.objects_ref.heatmap_line.clone();a.column_overlay=a.objects_ref.heatmap_line.clone();a.heatmap_layer.on("mouseleave",function(b){a.last_header=null;a.heatmap_overlay.destroyChildren();a.heatmap_overlay.draw();a.events.heatmap_onmouseout(b)})}};InCHlib.prototype._draw_heatmap_row=function(a,b,c){for(var d=this,e=d.data.nodes[a],g=new Kinetic.Group({id:a}),h,f,k,l,m,q=0,r=d.on_features.data.length;q<r;q++){l=d.on_features.data[q];h=b+d.pixels_for_dimension;f=c;m=k=e.features[l];if(d.settings.alternative_data&&
(m=d.alternative_data[a][l],d.settings.images_as_alternative_data&&void 0!==m&&null!==m&&""!=m)){k=null;var p=d.settings.images_path.dir+m+d.settings.images_path.ext;p=escape(p);if(void 0===d.path2image[m]){var t=new Image;t.src=p;t.onload=function(){d.image_counter++;d.image_counter===Object.keys(d.path2image).length&&d.heatmap_layer.draw()};d.path2image_obj[m]=t;d.path2image[m]=d.objects_ref.image.clone({image:d.path2image_obj[m]})}p=d.path2image[m].clone({width:d.pixels_for_dimension,height:d.pixels_for_leaf,
x:b,y:c-d._hack_round(.5*d.pixels_for_leaf),points:[b,c,b+d.pixels_for_dimension,null],column:["d",l].join("_"),value:m});g.add(p)}null===k||d.settings.images_as_alternative_data||(k=d._get_color_for_value(k,d.data_descs[l].min,d.data_descs[l].max,d.data_descs[l].middle,d.settings.heatmap_colors),l=d.objects_ref.heatmap_line.clone({stroke:k,points:[b,c,h,f],value:m,column:["d",l].join("_"),strokeWidth:d.pixels_for_leaf}),g.add(l),d.current_draw_values&&(m=d.objects_ref.heatmap_value.clone({x:d._hack_round((b+
h)/2-d.value_font_size/4*(""+m).length),y:d._hack_round(c-d.value_font_size/2),fontSize:d.value_font_size,text:m}),g.add(m)));b=h}d.settings.count_column&&d.features[d.dimensions.overall-1]&&(h=b+d.pixels_for_dimension,a=e.objects.length,k=d._get_color_for_value(a,d.min_item_count,d.max_item_count,d.middle_item_count,d.settings.count_column_colors),l=d.objects_ref.heatmap_line.clone({stroke:k,points:[b,c,h,f],value:a,column:"Count",strokeWidth:d.pixels_for_leaf}),g.add(l),d.current_draw_values&&(m=
d.objects_ref.heatmap_value.clone({text:a}),width=m.getWidth(),x=d._hack_round((b+h)/2-width/2),y=d._hack_round(c-d.value_font_size/2),m.position({x:x,y:y}),g.add(m)));return g};InCHlib.prototype._draw_column_metadata_row=function(a,b,c,d){for(var e=new Kinetic.Group({"class":"column_metadata"}),g,h,f,k,l=void 0===this.column_metadata_descs[b].str2num?!1:!0,m=0,q=this.on_features.data.length;m<q;m++)g=this.on_features.data[m],k=g=a[g],l&&(g=this.column_metadata_descs[b].str2num[g]),f=this._get_color_for_value(g,
this.column_metadata_descs[b].min,this.column_metadata_descs[b].max,this.column_metadata_descs[b].middle,this.settings.column_metadata_colors),g=c+this.pixels_for_dimension,h=d,c=this.objects_ref.heatmap_line.clone({strokeWidth:this.settings.column_metadata_row_height,stroke:f,value:k,points:[c,d,g,h],column:["cm",b].join("_")}),e.add(c),c=g;return e};InCHlib.prototype._bind_row_events=function(a){var b=this;a.on("mouseenter",function(a){b._row_mouseenter(a)});a.on("mouseleave",function(a){b._row_mouseleave(a)});
a.on("mouseover",function(a){b._draw_col_label(a)});a.on("mouseout",function(a){b.heatmap_overlay.find("#col_label")[0].destroy()});a.on("click",function(a){var c=a.target.parent.attrs.id;if("column_metadata"!==a.target.parent.attrs.class&&"metadata"!==a.target.parent.attrs.class){c=b.data.nodes[c].objects;var e=[];for(i=0;i<c.length;i++)e.push(c[i]);b.events.row_onclick(e,a)}})};InCHlib.prototype._draw_row_ids=function(){if(!(6>this.pixels_for_leaf||5>this.row_id_size)){var a=[];var b=0;keys=Object.keys(this.leaves_y_coordinates);
for(len=keys.length;b<len;b++){leaf_id=keys[b];var c=this.data.nodes[leaf_id].objects;if(1<c.length)return;a.push([c[0],this.leaves_y_coordinates[leaf_id]])}var d=this.heatmap_distance+this.heatmap_width+this.dendrogram_heatmap_distance+(this.settings.metadata?this.settings.metadata_col_width*this.on_features.metadata.length+this.dendrogram_heatmap_distance:0);for(b=0;b<a.length;b++)c=this.objects_ref.heatmap_value.clone({x:d,y:this._hack_round(a[b][1]-this.row_id_size/2),fontSize:this.row_id_size,
text:a[b][0],fontStyle:"italic",fill:"gray"}),this.header_layer.add(c)}};InCHlib.prototype._get_row_id_size=function(){for(var a,b=[],c=0,d=this.heatmap_array.length;c<d;c++){a=this.heatmap_array[c][0];a=this.data.nodes[a].objects;if(1<a.length)return;b.push(a[0])}b=this._get_max_length(b);d="";for(c=0;c<b;c++)d+="E";this.settings.fixed_row_id_size?(c=new Kinetic.Text({fontFamily:this.settings.font,fontSize:this.settings.fixed_row_id_size,fontStyle:"italic",listening:!1,text:d}),this.row_id_size=
this.settings.fixed_row_id_size,this.right_margin=20+c.width(),100>this.right_margin&&(this.right_margin=100)):(this.row_id_size=this._get_font_size(b,85,this.pixels_for_leaf,10),this.right_margin=100)};InCHlib.prototype._draw_heatmap_header=function(){var a=this;a.header_layer=new Kinetic.Layer;if(a.settings.column_metadata){a.column_metadata_descs=a._get_data_min_max_middle(a.column_metadata.features,"row");var b=a.heatmap_distance;var c=a.header_height+.5*a.settings.column_metadata_row_height;
for(var d=0,e=a.column_metadata.features.length;d<e;d++)heatmap_row=a._draw_column_metadata_row(a.column_metadata.features[d],d,b,c),a.header_layer.add(heatmap_row),a._bind_row_events(heatmap_row),c+=a.settings.column_metadata_row_height}if(a.settings.metadata)for(var g=0,h=Object.keys(a.leaves_y_coordinates),f=h.length;g<f;g++){node_id=h[g];var k=a.metadata.nodes[node_id];b=a.heatmap_distance+a.heatmap_width+a.dendrogram_heatmap_distance;c=a.leaves_y_coordinates[node_id];if(void 0!==k){var l=new Kinetic.Group({id:node_id,
"class":"metadata"});d=0;for(e=a.on_features.metadata.length;d<e;d++){col_index=a.on_features.metadata[d];value=k[col_index];var m=b+a.settings.metadata_col_width;null!==value&&void 0!==value&&(text_value=value,void 0!==a.metadata_descs[col_index].str2num&&(value=a.metadata_descs[col_index].str2num[value]),color=a._get_color_for_value(value,a.metadata_descs[col_index].min,a.metadata_descs[col_index].max,a.metadata_descs[col_index].middle,a.settings.metadata_colors),line=a.objects_ref.heatmap_line.clone({stroke:color,
points:[b,c,m,c],value:text_value,column:["m",col_index].join("_"),strokeWidth:a.pixels_for_leaf}),l.add(line));b=m;a.header_layer.add(l);a._bind_row_events(l)}}}a.settings.draw_row_ids&&a._draw_row_ids();a.header_layer.on("mouseleave",function(b){a.last_header=null;a.heatmap_overlay.destroyChildren();a.heatmap_overlay.draw()});if(a.settings.heatmap_header&&0<a.header.length){e=a._hack_size(a.leaves_y_coordinates);b=a.header_height+a.pixels_for_leaf*e+2*a.dendrogram_heatmap_distance+a.column_metadata_height;
c=a.settings.column_dendrogram&&a.heatmap_header?45:-45;m=0;g=[];d=0;for(e=a.on_features.data.length;d<e;d++)g.push(a.header[a.on_features.data[d]]);a.settings.count_column&&a.features[a.dimensions.overall-1]&&g.push(a.header[a.dimensions.overall-1]);e=a._get_max_length(g);k=a._get_font_size(e,a.header_height,a.pixels_for_dimension,a.settings.metadata_font_size);if(6<=k)for(d=0,e=g.length;d<e;d++)h=a.heatmap_distance+m*a.pixels_for_dimension+a.pixels_for_dimension,f=a.objects_ref.column_header.clone({x:h,
y:b,text:g[d],position_index:d,fontSize:k,fill:"gray",rotationDeg:c}),f.setOffset({y:f.getHeight()/2-a.pixels_for_dimension/2}),a.header_layer.add(f),m++;if(a.settings.metadata)for(h=a.heatmap_distance+g.length*a.pixels_for_dimension+a.dendrogram_heatmap_distance+a.settings.metadata_col_width,d=0,e=a.on_features.metadata.length;d<e;d++)h+=d*a.settings.metadata_col_width,f=a.objects_ref.column_header.clone({x:h,y:b,text:a.header[a.on_features.metadata[d]+a.dimensions.data],position_index:g.length+
d,fontSize:a.settings.metadata_font_size,rotationDeg:90}),f.setOffset({y:f.getHeight()/2-a.settings.metadata_col_width/2}),a.header_layer.add(f);a.stage.add(a.header_layer);a.settings.dendrogram||(a.header_layer.on("click",function(b){var c=b.target.attrs.position_index;for(d=0;d<a.header_layer.getChildren().length;d++)a.header_layer.getChildren()[d].setFill("black");b.target.setAttrs({fill:"red"});a._delete_layers([a.heatmap_layer,a.heatmap_overlay,a.highlighted_rows_layer,a.header_layer]);a._reorder_heatmap(a._translate_column_to_feature_index(c));
a._draw_heatmap();a._draw_heatmap_header()}),a.header_layer.on("mouseover",function(a){a.target.setOpacity(.7);this.draw()}),a.header_layer.on("mouseout",function(a){a.target.setOpacity(1);this.draw()}))}};InCHlib.prototype._translate_column_to_feature_index=function(a){for(var b,c=-1,d=0,e=Object.keys(this.features),g=e.length;d<g;d++)if(b=e[d],this.features[b]&&(c++,a===c))return b};InCHlib.prototype._draw_distance_scale=function(a){if(this.settings.navigation_toggle.distance_scale){var b=this.header_height+
this.column_metadata_height+this.settings.column_metadata_row_height/2-10,c=this.distance,d=new Kinetic.Line({points:[0,b,c,b],stroke:"black",listening:!1}),e=new Kinetic.Circle({x:c,y:b,radius:3,fill:"black",listening:!1}),g=0,f=this._hack_round(30/this.distance_step*10)/10;a=Math.round(100*this.distance/this.distance_step)/100;var n=this._hack_round(this.distance_step*f),k=0;a=new Kinetic.Text({x:0,y:b-20,text:a,fontSize:12,fontFamily:this.settings.font,fontStyle:"bold",fill:"black",align:"right",
listening:!1});this.dendrogram_layer.add(d,e,a);0==n&&(n=.5);if(.1<f)for(;0<c;)d=new Kinetic.Line({points:[c,b-3,c,b+3],stroke:"black",listening:!1}),this.dendrogram_layer.add(d),g=this._hack_round(10*(g+f))/10,10<g&&(g=this._hack_round(g)),c-=n,k++}};InCHlib.prototype._draw_navigation=function(){var a=this;a.navigation_layer=new Kinetic.Layer;var b=0,c=10;a.settings.heatmap&&a._draw_color_scale();a._draw_help();if(!a.settings.column_dendrogram&&a.settings.heatmap&&a.settings.navigation_toggle.filter_button){var d=
a.objects_ref.icon.clone({data:"M26.834,6.958c0-2.094-4.852-3.791-10.834-3.791c-5.983,0-10.833,1.697-10.833,3.791c0,0.429,0.213,0.84,0.588,1.224l8.662,15.002v4.899c0,0.414,0.709,0.75,1.583,0.75c0.875,0,1.584-0.336,1.584-0.75v-4.816l8.715-15.093h-0.045C26.625,7.792,26.834,7.384,26.834,6.958zM16,9.75c-6.363,0-9.833-1.845-9.833-2.792S9.637,4.167,16,4.167c6.363,0,9.834,1.844,9.834,2.791S22.363,9.75,16,9.75z",x:b,y:c,label:"Filter\ncolumns"}),e=a._draw_icon_overlay(b,c);a.navigation_layer.add(d,e);b+=
40;e.on("click",function(){a._filter_icon_click(this)});e.on("mouseover",function(){a._icon_mouseover(d,e,a.navigation_layer)});e.on("mouseout",function(){a._icon_mouseout(d,e,a.navigation_layer)})}if(0<a.zoomed_clusters.row.length||0<a.zoomed_clusters.column.length){var g=a.objects_ref.icon.clone({data:"M24.083,15.5c-0.009,4.739-3.844,8.574-8.583,8.583c-4.741-0.009-8.577-3.844-8.585-8.583c0.008-4.741,3.844-8.577,8.585-8.585c1.913,0,3.665,0.629,5.09,1.686l-1.782,1.783l8.429,2.256l-2.26-8.427l-1.89,1.89c-2.072-1.677-4.717-2.688-7.587-2.688C8.826,3.418,3.418,8.826,3.416,15.5C3.418,22.175,8.826,27.583,15.5,27.583S27.583,22.175,27.583,15.5H24.083z",
x:b,y:c,id:"refresh_icon",label:"Refresh"}),f=a._draw_icon_overlay(b,c);a.navigation_layer.add(g,f);f.on("click",function(){a._refresh_icon_click();a.events.on_refresh()});f.on("mouseover",function(){a._icon_mouseover(g,f,a.navigation_layer)});f.on("mouseout",function(){a._icon_mouseout(g,f,a.navigation_layer)})}if(0<a.zoomed_clusters.row.length){b=a.distance-55;c=a.settings.height-a.footer_height+20;var n=a.objects_ref.icon.clone({data:a.paths_ref.unzoom_icon,x:b,y:c,scale:{x:.7,y:.7},label:"Unzoom\nrows"}),
k=a._draw_icon_overlay(b,c);a.navigation_layer.add(n,k);k.on("click",function(){a._unzoom_icon_click()});k.on("mouseover",function(){a._icon_mouseover(n,k,a.navigation_layer)});k.on("mouseout",function(){a._icon_mouseout(n,k,a.navigation_layer)})}if(0<a.zoomed_clusters.column.length){b=a.settings.width-85;c=a.header_height-50;var l=a.objects_ref.icon.clone({data:a.paths_ref.unzoom_icon,x:b,y:c-5,scale:{x:.7,y:.7},label:"Unzoom\ncolumns"}),m=a._draw_icon_overlay(b,c);a.navigation_layer.add(l,m);m.on("click",
function(){a._column_unzoom_icon_click(this)});m.on("mouseover",function(){a._icon_mouseover(l,m,a.navigation_layer)});m.on("mouseout",function(){a._icon_mouseout(l,m,a.navigation_layer)})}if(a.settings.navigation_toggle.export_button){var q=a.objects_ref.icon.clone({data:"M24.25,10.25H20.5v-1.5h-9.375v1.5h-3.75c-1.104,0-2,0.896-2,2v10.375c0,1.104,0.896,2,2,2H24.25c1.104,0,2-0.896,2-2V12.25C26.25,11.146,25.354,10.25,24.25,10.25zM15.812,23.499c-3.342,0-6.06-2.719-6.06-6.061c0-3.342,2.718-6.062,6.06-6.062s6.062,2.72,6.062,6.062C21.874,20.78,19.153,23.499,15.812,23.499zM15.812,13.375c-2.244,0-4.062,1.819-4.062,4.062c0,2.244,1.819,4.062,4.062,4.062c2.244,0,4.062-1.818,4.062-4.062C19.875,15.194,18.057,13.375,15.812,13.375z",
x:a.settings.width-62,y:10,scale:{x:.7,y:.7},id:"export_icon",label:"Export\nin png format"}),r=a._draw_icon_overlay(a.settings.width-62,10);a.navigation_layer.add(q,r);r.on("click",function(){a._export_icon_click(this)});r.on("mouseover",function(){a._icon_mouseover(q,r,a.navigation_layer)});r.on("mouseout",function(){a._icon_mouseout(q,r,a.navigation_layer)})}a.stage.add(a.navigation_layer)};InCHlib.prototype._draw_help=function(){var a=this;if(a.settings.navigation_toggle.hint_button){var b=a.objects_ref.icon.clone({data:a.paths_ref.lightbulb,
x:a.settings.width-63,y:40,scale:{x:.8,y:.8},id:"help_icon",label:"Tip"}),c=a._draw_icon_overlay(a.settings.width-63,40);a.navigation_layer.add(b,c);c.on("mouseover",function(){a._icon_mouseover(b,c,a.navigation_layer);a._help_mouseover()});c.on("mouseout",function(){a._help_mouseout();a._icon_mouseout(b,c,a.navigation_layer)})}};InCHlib.prototype._draw_color_scale=function(){var a=this;if(a.settings.navigation_toggle.color_scale){var b=[a.settings.min_percentile/100,a._get_color_for_value(0,0,1,
.5,a.settings.heatmap_colors),a.settings.middle_percentile/100,a._get_color_for_value(.5,0,1,.5,a.settings.heatmap_colors),a.settings.max_percentile/100,a._get_color_for_value(1,0,1,.5,a.settings.heatmap_colors)],c=a.objects_ref.rect_gradient.clone({label:"Color settings",fillLinearGradientColorStops:b,id:a.settings.target+"_color_scale"});c.on("mouseover",function(){a._color_scale_mouseover(c,a.navigation_layer)});c.on("mouseout",function(){a._color_scale_mouseout(c,a.navigation_layer)});c.on("click",
function(){a._color_scale_click(c,a.navigation_layer)});a.navigation_layer.add(c)}};InCHlib.prototype._update_color_scale=function(){this.navigation_layer.find("#"+this.settings.target+"_color_scale").fillLinearGradientColorStops([this.settings.min_percentile/100,this._get_color_for_value(0,0,1,.5,this.settings.heatmap_colors),this.settings.middle_percentile/100,this._get_color_for_value(.5,0,1,.5,this.settings.heatmap_colors),this.settings.max_percentile/100,this._get_color_for_value(1,0,1,.5,this.settings.heatmap_colors)]);
this.navigation_layer.draw()};InCHlib.prototype._draw_icon_overlay=function(a,b){return this.objects_ref.icon_overlay.clone({x:a,y:b})};InCHlib.prototype._highlight_path=function(a,b){var c=this.data.nodes[a];1!=c.count?(this.dendrogram_layer.get("#"+a)[0].stroke(b),this._highlight_path(c.left_child,b),this._highlight_path(c.right_child,b)):(this.highlighted_rows_y.push(this.leaves_y_coordinates[a]),this.current_object_ids.push.apply(this.current_object_ids,c.objects))};InCHlib.prototype._highlight_column_path=
function(a,b){var c=this.column_dendrogram.nodes[a];1!=c.count?(this.column_dendrogram_layer.get("#col"+a)[0].stroke(b),this._highlight_column_path(c.left_child,b),this._highlight_column_path(c.right_child,b)):this.current_column_ids.push(this.nodes2columns[a])};InCHlib.prototype.unhighlight_rows=function(){this.highlight_rows([])};InCHlib.prototype.highlight_rows=function(a){var b=this,c;if(b.settings.heatmap){b.settings.highlighted_rows=a;b.highlighted_rows_layer.destroyChildren();var d=b.settings.heatmap_colors,
e=b.settings.metadata_colors;b.settings.heatmap_colors=b.settings.highlight_colors;b.settings.metadata_colors=b.settings.highlight_colors;var g={},f=[];for(c=0;c<a.length;c++)if(void 0!==b.objects2leaves[a[c]]){var n=b.objects2leaves[a[c]];void 0===g[n]&&(f.push(n),g[n]=null)}for(c=0;c<f.length;c++)a=b._draw_heatmap_row(f[c],b.heatmap_distance,b.leaves_y_coordinates[f[c]]),b.highlighted_rows_layer.add(a),a.setAttr("listening",!1);b.highlighted_rows_layer.draw();b.heatmap_overlay.moveToTop();b.settings.heatmap_colors=
d;b.settings.metadata_colors=e;b.highlighted_rows_layer.on("click",function(a){b.heatmap_layer.fire("click")})}};InCHlib.prototype._highlight_cluster=function(a){var b=this.last_highlighted_cluster;b&&this.unhighlight_cluster();b!==a&&(this.last_highlighted_cluster=a,this._highlight_path(a,"#F5273C"),this._draw_cluster_layer(a),this.events.dendrogram_node_highlight(this.current_object_ids,this._unprefix(a)));this.dendrogram_layer.draw()};InCHlib.prototype._highlight_column_cluster=function(a){var b=
this.last_highlighted_column_cluster;b&&this.unhighlight_column_cluster();b!==a&&(this.last_highlighted_column_cluster=a,this._highlight_column_path(a,"#F5273C"),this.current_column_ids.sort(function(a,b){return a-b}),this._draw_column_cluster_layer(a),this.events.column_dendrogram_node_highlight(this.current_column_ids,this._unprefix(a)));this.column_dendrogram_layer.draw()};InCHlib.prototype.unhighlight_column_cluster=function(){this.last_highlighted_column_cluster&&(this._highlight_column_path(this.last_highlighted_column_cluster,
"grey"),this.column_dendrogram_layer.draw(),this.column_cluster_group.destroy(),this.cluster_layer.draw(),this.current_column_ids=[],this.events.column_dendrogram_node_unhighlight(this._unprefix(this.last_highlighted_column_cluster)),this.last_highlighted_column_cluster=null)};InCHlib.prototype.highlight_cluster=function(a){return this._highlight_cluster(this._prefix(a))};InCHlib.prototype.highlight_column_cluster=function(a){return this._highlight_column_cluster(this._prefix(a))};InCHlib.prototype.unhighlight_cluster=
function(){this.last_highlighted_cluster&&(this._highlight_path(this.last_highlighted_cluster,"grey"),this.dendrogram_layer.draw(),this.row_cluster_group.destroy(),this.cluster_layer.draw(),this.events.dendrogram_node_unhighlight(this._unprefix(this.last_highlighted_cluster)),this.highlighted_rows_y=[],this.current_object_ids=[],this.last_highlighted_cluster=null)};InCHlib.prototype._neutralize_path=function(a){var b=this.data.nodes[a];1!=b.count&&(a=this.dendrogram_layer.get("#"+a)[0])&&(a.setStroke("grey"),
this._neutralize_path(b.right_child),this._neutralize_path(b.left_child))};InCHlib.prototype._draw_cluster_layer=function(a){var b=this;b.row_cluster_group=new Kinetic.Group;var c=b._get_visible_count(),d=b.distance-30,e=b.settings.height-b.footer_height+20;a=b.objects_ref.count.clone({x:d+10,y:e-10,text:b.data.nodes[a].count});var g=b.objects_ref.icon.clone({data:b.paths_ref.zoom_icon,x:d,y:e,scale:{x:.7,y:.7},label:"Zoom\nrows"}),f=b._draw_icon_overlay(d,e);d=b.distance+b.dendrogram_heatmap_distance;
e=c*b.pixels_for_dimension+b.heatmap_distance;var n=b.highlighted_rows_y[0]-b.pixels_for_leaf/2,k=b.highlighted_rows_y[b.highlighted_rows_y.length-1]+b.pixels_for_leaf/2;c=b.objects_ref.cluster_overlay.clone({x:d,y:b.header_height+b.column_metadata_height+5,width:b.settings.width-b.heatmap_distance,height:b._hack_round(n-b.header_height-b.column_metadata_height-b.dendrogram_heatmap_distance)});n=b.objects_ref.cluster_border.clone({points:[0,n,e+b.dendrogram_heatmap_distance+b.on_features.metadata.length*
b.settings.metadata_col_width,n]});d=b.objects_ref.cluster_overlay.clone({x:d,y:k,width:b.settings.width-b.heatmap_distance,height:b.settings.height-k-b.footer_height+8});e=b.objects_ref.cluster_border.clone({points:[0,k,e+b.dendrogram_heatmap_distance+b.on_features.metadata.length*b.settings.metadata_col_width,k]});b.row_cluster_group.add(a,c,d,g,f,n,e);b.cluster_layer.add(b.row_cluster_group);b.stage.add(b.cluster_layer);a.moveToTop();b.cluster_layer.draw();b.navigation_layer.moveToTop();f.on("mouseover",
function(){b._icon_mouseover(g,f,b.cluster_layer)});f.on("mouseout",function(){b._icon_mouseout(g,f,b.cluster_layer)});f.on("click",function(){b._zoom_cluster(b.last_highlighted_cluster)})};InCHlib.prototype._draw_column_cluster_layer=function(a){var b=this;b.column_cluster_group=new Kinetic.Group;var c=b.settings.width-85,d=b.header_height-25;a=b.objects_ref.count.clone({x:c+15,y:d-5,text:b.column_dendrogram.nodes[a].count});var e=b.objects_ref.icon.clone({data:b.paths_ref.zoom_icon,x:c,y:d,scale:{x:.7,
y:.7},label:"Zoom\ncolumns"}),g=b._draw_icon_overlay(c,d),f=b._hack_round((b.current_column_ids[0]-b.columns_start_index)*b.pixels_for_dimension);d=b._hack_round((b.current_column_ids[0]+b.current_column_ids.length-b.columns_start_index)*b.pixels_for_dimension);var n=b.settings.height-b.footer_height+b.dendrogram_heatmap_distance,k=b.settings.height-b.header_height+b.dendrogram_heatmap_distance;c=b.objects_ref.cluster_border.clone({points:[b.heatmap_distance+f,0,b.heatmap_distance+f,n]});f=b.objects_ref.cluster_overlay.clone({x:b.heatmap_distance,
y:b.header_height,width:f,height:k});n=b.objects_ref.cluster_border.clone({points:[b.heatmap_distance+d,0,b.heatmap_distance+d,n]});d=b.objects_ref.cluster_overlay.clone({x:d+b.heatmap_distance,y:b.header_height,width:b.heatmap_width-d-b.on_features.count_column.length*b.pixels_for_dimension,height:k});b.column_cluster_group.add(f,d,e,g,a,c,n);b.cluster_layer.add(b.column_cluster_group);b.stage.add(b.cluster_layer);b.cluster_layer.draw();b.navigation_layer.moveToTop();g.on("mouseover",function(){b._icon_mouseover(e,
g,b.cluster_layer)});g.on("mouseout",function(){b._icon_mouseout(e,g,b.cluster_layer)});g.on("click",function(){b._zoom_column_cluster(b.last_highlighted_column_cluster)})};InCHlib.prototype._draw_column_cluster=function(a){this.columns_start_index=this.current_column_ids[0];this.on_features.data=this.current_column_ids;var b=this.distance;this._adjust_horizontal_sizes();this._delete_layers([this.column_dendrogram_layer,this.heatmap_layer,this.heatmap_overlay,this.column_cluster_group,this.navigation_layer,
this.highlighted_rows_layer],[this.dendrogram_hover_layer]);this.settings.heatmap_header&&this._delete_layers([this.header_layer]);this._draw_column_dendrogram(a);this._draw_heatmap();this._draw_heatmap_header();this._draw_navigation();b!==this.distance?(this._delete_layers([this.dendrogram_layer,this.cluster_layer]),this._draw_row_dendrogram(0<this.zoomed_clusters.row.length?this.zoomed_clusters.row[this.zoomed_clusters.row.length-1]:this.root_id),null!==this.last_highlighted_cluster&&(this._highlight_path(this.last_highlighted_cluster,
"#F5273C"),this.dendrogram_layer.draw(),this._draw_cluster_layer(this.last_highlighted_cluster))):(this.cluster_layer.moveToTop(),this.cluster_layer.draw())};InCHlib.prototype._zoom_column_cluster=function(a){a!=this.column_root_id&&(this.zoomed_clusters.column.push(a),this._draw_column_cluster(a),this.highlight_rows(this.settings.highlighted_rows),this.events.on_columns_zoom(this.current_column_ids,this._unprefix(a)),this.current_column_ids=[],this.last_highlighted_column_cluster=null)};InCHlib.prototype._unzoom_column_cluster=
function(){var a=this.zoomed_clusters.column.pop(),b=this.zoomed_clusters.column.length;b=0<b?this.zoomed_clusters.column[b-1]:this.column_root_id;this._get_column_ids(b);this._draw_column_cluster(b);this.events.on_columns_unzoom(this._unprefix(a));this.current_column_ids=[];this._highlight_column_cluster(a)};InCHlib.prototype._draw_cluster=function(a){this._delete_layers([this.dendrogram_layer,this.heatmap_layer,this.heatmap_overlay,this.cluster_layer,this.navigation_layer,this.header_layer,this.highlighted_rows_layer],
[this.dendrogram_hover_layer]);this._draw_row_dendrogram(a);this._draw_heatmap();this._draw_heatmap_header();this._draw_navigation();this.settings.column_dendrogram&&null!==this.last_highlighted_column_cluster&&this._draw_column_cluster_layer(this.last_highlighted_column_cluster)};InCHlib.prototype._zoom_cluster=function(a){a!==this.root_id&&(this.zoomed_clusters.row.push(a),this._draw_cluster(a),this.highlight_rows(this.settings.highlighted_rows),this.events.on_zoom(this.current_object_ids,this._unprefix(a)),
this.highlighted_rows_y=[],this.current_object_ids=[],this.last_highlighted_cluster=null)};InCHlib.prototype._unzoom_cluster=function(){var a=this.zoomed_clusters.row.pop(),b=this.zoomed_clusters.row.length;this._draw_cluster(0<b?this.zoomed_clusters.row[b-1]:this.root_id);this.events.on_unzoom(this._unprefix(a));this._highlight_cluster(a)};InCHlib.prototype._get_node_neighbourhood=function(a,b){var c={left_node:{left_node:{left_count:0,right_count:0},right_node:{left_count:0,right_count:0},left_count:.5,
right_count:.5},right_node:{left_node:{left_count:0,right_count:0},right_node:{left_count:0,right_count:0},left_count:.5,right_count:.5},left_count:b[a.left_child].count,right_count:b[a.right_child].count},d=b[a.left_child];a=b[a.right_child];var e=b[d.left_child],g=b[d.right_child],f=b[a.left_child],n=b[a.right_child];1!=d.count&&(c.left_node.left_count=b[d.left_child].count,c.left_node.right_count=b[d.right_child].count,1!=e.count?(c.left_node.left_node.left_count=b[e.left_child].count,c.left_node.left_node.right_count=
b[e.right_child].count):(c.left_node.left_node.left_count=.5,c.left_node.left_node.right_count=.5),1!=g.count?(c.left_node.right_node.left_count=b[g.left_child].count,c.left_node.right_node.right_count=b[g.right_child].count):(c.left_node.right_node.left_count=.5,c.left_node.right_node.right_count=.5));1!=a.count&&(c.right_node.left_count=b[a.left_child].count,c.right_node.right_count=b[a.right_child].count,1!=f.count?(c.right_node.left_node.left_count=b[f.left_child].count,c.right_node.left_node.right_count=
b[f.right_child].count):(c.right_node.left_node.left_count=.5,c.right_node.left_node.right_count=.5),1!=n.count?(c.right_node.right_node.left_count=b[n.left_child].count,c.right_node.right_node.right_count=b[n.right_child].count):(c.right_node.right_node.left_count=.5,c.right_node.right_node.right_count=.5));return c};InCHlib.prototype._draw_column_dendrogram_node=function(a,b,c,d,e,g){if(1<b.count){e=this._get_node_neighbourhood(b,this.column_dendrogram.nodes);g=this.column_dendrogram.nodes[b.right_child];
var f=this.column_dendrogram.nodes[b.left_child],n=this._get_x1(e,c,d),k=this._get_x2(e,c,d),l=this._hack_round(this.vertical_distance-this.vertical_distance_step*b.distance),m=l=0==l?2:l;1==g.count&&(k-=this.pixels_for_dimension/2);var q=this.vertical_distance-this.vertical_distance_step*this.column_dendrogram.nodes[b.left_child].distance,r=this.vertical_distance-this.vertical_distance_step*this.column_dendrogram.nodes[b.right_child].distance;this.column_dendrogram_layer.add(this._draw_vertical_path(a,
n,l,k,m,q,r));this._draw_column_dendrogram_node(b.left_child,f,c-e.left_node.right_count,d+e.left_node.right_count,q,l);this._draw_column_dendrogram_node(b.right_child,g,c+e.right_node.left_count,d-e.right_node.left_count,r,m)}else this.column_x_coordinates[a]=d*this.pixels_for_dimension};InCHlib.prototype._get_y1=function(a,b,c){b=b-a.left_node.right_count-a.left_node.left_node.right_count;return(b+(a.left_node.left_node.right_count+a.left_node.right_node.left_count)/2)*this.pixels_for_leaf+this.top_heatmap_distance};
InCHlib.prototype._get_y2=function(a,b,c){b+=a.right_node.left_node.left_count;return(b+(a.right_node.left_node.right_count+a.right_node.right_node.left_count)/2)*this.pixels_for_leaf+this.top_heatmap_distance};InCHlib.prototype._get_x1=function(a,b,c){b=b-a.left_node.right_count-a.left_node.left_node.right_count;return this.heatmap_distance+this.on_features.data.length*this.pixels_for_dimension-(b+(a.left_node.left_node.right_count+a.left_node.right_node.left_count)/2)*this.pixels_for_dimension};
InCHlib.prototype._get_x2=function(a,b,c){b+=a.right_node.left_node.left_count;return this.heatmap_distance+this.on_features.data.length*this.pixels_for_dimension-(b+(a.right_node.left_node.right_count+a.right_node.right_node.left_count)/2)*this.pixels_for_dimension};InCHlib.prototype._draw_vertical_path=function(a,b,c,d,e,g,f){var h=new Kinetic.Group({});e=this.objects_ref.node.clone({points:[b,g,b,c,d,e,d,f],id:"col"+a});a=this.objects_ref.node_rect.clone({x:d-1,y:c-1,width:b-d+2,height:this.header_height-
c,id:"col_rect"+a,path:e,path_id:a});h.add(e,a);return h};InCHlib.prototype._draw_horizontal_path=function(a,b,c,d,e,g,f){var h=new Kinetic.Group({});d=this.objects_ref.node.clone({points:[g,c,b,c,d,e,f,e],id:a});a=this.objects_ref.node_rect.clone({x:b-1,y:c-1,width:this.distance-b,height:e-c,id:[a,"rect"].join("_"),path:d,path_id:a});h.add(d,a);return h};InCHlib.prototype._filter_icon_click=function(a){var b=this,c=b.target_element.find(".filter_features");a="\u2716";if(c.length){c.fadeIn("fast");
var d=b._draw_target_overlay()}else{filter_list="";for(var e in b.header)if(b.features[e]&&(a="\u2714"),e<b.dimensions){var g=b.header[e];""==g&&(g=parseInt(e)+1+". column");filter_list=filter_list+"<li class='feature_switch' data-num='"+e+"'><span class='symbol'>"+a+"</span>  "+g+"</li>"}b.target_element.append("<div class='filter_features'><ul>"+filter_list+"</ul><hr /><div><span class='cancel_filter_list'>Cancel</span>&nbsp;&nbsp;&nbsp;<span class='update_filter_list'>Update</span></div></div>");
c=b.target_element.find(".filter_features");c.css({display:"none",top:45,left:0,"border-radius":"5px","text-align":"center",position:"absolute","background-color":"#ffffff",border:"solid 2px #DEDEDE","padding-top":"5px","padding-left":"15px","padding-bottom":"10px","padding-right":"15px","font-weight":"bold","font-size":"14px","z-index":1E3,"font-family":b.settings.font});c.find("ul").css({"list-style-type":"none","margin-left":"0","padding-left":"0","text-align":"left"});c.find("li").css({color:"green",
"margin-top":"5px"});c.find("div").css({cursor:"pointer",opacity:"0.7"});d=b._draw_target_overlay();c.fadeIn("fast");b.target_element.find(".feature_switch").click(function(){var a=parseInt(f(this).attr("data-num")),c=f(this).find("span");b.features[a]=!b.features[a];b.features[a]?(c.text("\u2714"),f(this).css("color","green")):(c.text("\u2716"),f(this).css("color","red"));b._set_on_features()});f(function(){c.click(function(){return!1});c.mousedown(function(){return!1});f("#"+b.settings.target+" .filter_features ul li,#"+
b.settings.target+" .filter_features div span").hover(function(){f(this).css({cursor:"pointer",opacity:"0.7"})},function(){f(this).css({cursor:"default",opacity:"1"})})});b.target_element.find(".cancel_filter_list").click(function(){c.fadeOut("fast");d.fadeOut("fast")});d.click(function(){c.fadeOut("fast");d.fadeOut("fast")});b.target_element.find(".update_filter_list").click(function(){c.fadeOut("slow");d.fadeOut("slow");var a=0<b.zoomed_clusters.row.length?b.zoomed_clusters.row[b.zoomed_clusters.row.length-
1]:b.root_id,e=b.last_highlighted_cluster;b.last_highlighted_cluster=null;b._adjust_horizontal_sizes();b._delete_all_layers();b._draw_stage_layer();b.settings.dendrogram&&(b._draw_dendrogram_layers(),b._draw_row_dendrogram(a),b._draw_dendrogram_layers(),b.settings.column_dendrogram&&b._visible_features_equal_column_dendrogram_count()&&b._draw_column_dendrogram(b.column_root_id));b._draw_navigation();b._draw_heatmap();b._draw_heatmap_header();null!=e&&b._highlight_cluster(e)})}};InCHlib.prototype._draw_target_overlay=
function(){var a=this.target_element.find(".target_overlay");a.length?a.fadeIn("fast"):(a=f("<div class='target_overlay'></div>"),a.css({"background-color":"white",position:"absolute",top:0,left:0,right:0,bottom:0,opacity:.5}),this.target_element.append(a));return a};InCHlib.prototype._refresh_icon_click=function(){this.redraw()};InCHlib.prototype._export_icon_click=function(){var a=this,b=a.target_element.find(".export_menu"),c=a._draw_target_overlay();if(b.length)b.fadeIn("fast");else{b=f("<div class='export_menu'><div><button type='submit' data-action='open'>Show image</button></div><div><button type='submit' data-action='save'>Save image</button></div></div>");
a.target_element.append(b);b.css({position:"absolute",top:45,left:a.settings.width-125,"font-size":"12px",border:"solid #D2D2D2 1px","border-radius":"5px",padding:"2px","background-color":"white"});var d=b.find("button");d.css({"padding-top":"7px","padding-bottom":"5px","padding-right":"8px","padding-left":"8px",color:"white",border:"solid #D2D2D2 1px",width:"100%","background-color":"#2171b5","font-weight":"bold"});d.hover(function(){f(this).css({cursor:"pointer",opacity:.7})},function(){f(this).css({opacity:1})});
c.click(function(){b.fadeOut("fast");c.fadeOut("fast")});d.click(function(){var b=f(this).attr("data-action"),d=a.stage.width(),h=a.stage.height(),n=f("<h3 style='margin-top: 100px; margin-left: 100px; width: "+d+"px; height: "+h+"px;'>Loading...</h3>");a.target_element.after(n);a.target_element.hide();a.stage.width(3*d);a.stage.height(3*h);a.stage.scale({x:3,y:3});a.stage.draw();a.navigation_layer.hide();a.stage.toDataURL({quality:1,callback:function(e){"open"===b?window.open(e,"_blank"):f('<a download="inchlib" href="'+
e+'"></a>')[0].click();a.stage.width(d);a.stage.height(h);a.stage.scale({x:1,y:1});a.stage.draw();n.remove();a.target_element.show();a.navigation_layer.show();a.navigation_layer.draw();c.trigger("click")}})})}};InCHlib.prototype._color_scale_click=function(a,b){var c=this,d;b={heatmap_colors:"Heatmap data colors"};var e={max_percentile:"Max percentile value",middle_percentile:"Middle percentile value",min_percentile:"Min percentile value"};c.settings.metadata&&(b.metadata_colors="Metadata colors");
c.settings.column_metadata&&(b.column_metadata_colors="Column metadata colors");var g="settings_form_"+c.settings.target,h=f("#"+g),n=c._draw_target_overlay();if(h.length)h.fadeIn("fast");else{h=f("<form class='settings_form' id='"+g+"'></form>");var k="";a=0;keys=Object.keys(b);for(len=keys.length;a<len;a++){var l=keys[a];var m=c._get_color_for_value(0,0,1,.5,c.settings[l]);var q=c._get_color_for_value(.5,0,1,.5,c.settings[l]);var r=c._get_color_for_value(1,0,1,.5,c.settings[l]);var p="<div><div class='form_label'>"+
b[l]+"</div><input type='text' name='"+l+"' value='"+c.settings[l]+"'/> <div class='color_button' style='background: linear-gradient(to right, "+m+","+q+","+r+")'></div></div>";k+=p}a=0;keys=Object.keys(e);for(len=keys.length;a<len;a++)l=keys[a],p="<div><div class='form_label'>"+e[l]+"</div><input type='text' name='"+l+"' value='"+c.settings[l]+"'/></div>",k+=p;p="<div><div class='form_label'>Heatmap coloring</div><select name='independent_columns'>";p=c.settings.independent_columns?p+"<option value='true' selected>By columns</option><option value='false'>Entire heatmap</option>":
p+"<option value='true'>By columns</option><option value='false' selected>Entire heatmap</option>";p+="</select></div>";h.html(k+p+'<button type="submit">Redraw</button>');c.target_element.append(h);h.css({"z-index":1E3,position:"absolute",top:110,left:0,padding:"10px",border:"solid #D2D2D2 2px","border-radius":"5px","background-color":"white"});f("#"+g+" .color_button").css({border:"solid #D2D2D2 1px",height:"15px",width:"30px",display:"inline-block"});f("#"+g+" > div").css({"font-size":"12px","margin-bottom":"10px"});
f("#"+g+" input").css({"border-radius":"5px",width:"100px"});f("#"+g+" .form_label").css({color:"gray","margin-bottom":"5px","font-style":"italic"});f("#"+g+" button").css({"padding-top":"7px","padding-bottom":"5px","padding-right":"5px","padding-left":"5px",color:"white",border:"solid #D2D2D2 1px","border-radius":"5px",width:"100%","background-color":"#2171b5","font-weight":"bold"});n.click(function(){h.fadeOut("fast");n.fadeOut("fast")});a=f("#"+g+" .color_button");a.hover(function(){f(this).css({cursor:"pointer",
opacity:.7})},function(){f(this).css({opacity:1})});a.click(function(a){c._draw_color_scales_select(this,a)});h.submit(function(a){var b={};f(this).find("input, select").each(function(){p=f(this);l=p.attr("name");d=p.val();""!=d&&("true"===d?d=!0:"false"===d&&(d=!1),b[l]=d)});c.update_settings(b);c.redraw_heatmap();c._update_color_scale();n.trigger("click");a.preventDefault();a.stopPropagation()})}};InCHlib.prototype._draw_color_scales_select=function(a,b){var c=this,d=c.target_element.find(".color_scales");
if(d.length){d.fadeIn("fast");var e=d.find(".color_scale")}else{d=f("<div class='color_scales'></div>");b=0;for(var g=Object.keys(c.colors),h=g.length;b<h;b++){var n=g[b];var k=c._get_color_for_value(0,0,1,.5,n);var l=c._get_color_for_value(.5,0,1,.5,n);var m=c._get_color_for_value(1,0,1,.5,n);k="<div class='color_scale' data-scale_acronym='"+n+"' style='background: linear-gradient(to right, "+k+","+l+","+m+")'></div>";d.append(k)}c.target_element.append(d);d.css({border:"solid #D2D2D2 2px","border-radius":"5px",
padding:"5px",position:"absolute",top:110,left:170,"background-color":"white"});e=c.target_element.find(".color_scale");e.css({"margin-top":"3px",width:"80px",height:"20px",border:"solid #D2D2D2 1px"});e.hover(function(){f(this).css({cursor:"pointer",opacity:.7})},function(){f(this).css({opacity:1})});c.target_element.find(".target_overlay").click(function(){d.fadeOut("fast")})}e.on("click",function(){var b=f(this).attr("data-scale_acronym");f(a).prev("input:first").val(b);f(a).css({background:"linear-gradient(to right, "+
c._get_color_for_value(0,0,1,.5,b)+","+c._get_color_for_value(.5,0,1,.5,b)+","+c._get_color_for_value(1,0,1,.5,b)+")"});d.fadeOut("fast");e.off("click")})};InCHlib.prototype._color_scale_mouseover=function(a,b){var c=a.getAttr("label"),d=a.getAttr("x"),e=a.getAttr("y");this.icon_tooltip=this.objects_ref.tooltip_label.clone({x:d,y:e+25});this.icon_tooltip.add(this.objects_ref.tooltip_tag.clone());this.icon_tooltip.add(this.objects_ref.tooltip_text.clone({text:c}));b.add(this.icon_tooltip);this.icon_tooltip.moveToTop();
a.setOpacity(.7);b.draw()};InCHlib.prototype._color_scale_mouseout=function(a,b){this.icon_tooltip.destroy();a.setOpacity(1);b.draw()};InCHlib.prototype._unzoom_icon_click=function(){this._unzoom_cluster()};InCHlib.prototype._column_unzoom_icon_click=function(){this._unzoom_column_cluster()};InCHlib.prototype._icon_mouseover=function(a,b,c){if("help_icon"!==a.getAttr("id")){var d=a.getAttr("label"),e=b.getAttr("x"),g=b.getAttr("y");b.getWidth();b=b.getHeight();"export_icon"===a.getAttr("id")&&(e-=
100,g-=50);this.icon_tooltip=this.objects_ref.tooltip_label.clone({x:e,y:g+1.2*b});this.icon_tooltip.add(this.objects_ref.tooltip_tag.clone());this.icon_tooltip.add(this.objects_ref.tooltip_text.clone({text:d}));c.add(this.icon_tooltip)}a.setFill("black");c.draw()};InCHlib.prototype._icon_mouseout=function(a,b,c){"help_icon"!==a.getAttr("id")&&this.icon_tooltip.destroy();a.setFill("grey");c.draw()};InCHlib.prototype._help_mouseover=function(){var a=this.target_element.find(".inchlib_help");a.length?
a.show():(a=f("<div class='inchlib_help'><ul><li>Zoom clusters by a long click on a dendrogram node.</li></ul></div>"),a.css({position:"absolute",top:70,left:this.settings.width-200,"font-size":12,"padding-right":15,width:200,"background-color":"white","border-radius":5,border:"solid #DEDEDE 2px","z-index":1E3}),this.target_element.append(a))};InCHlib.prototype._help_mouseout=function(){this.target_element.find(".inchlib_help").hide()};InCHlib.prototype._dendrogram_layers_click=function(a,b){var c=
b.target.attrs.path_id;a.fire("mouseout",a,b);this._highlight_cluster(c);this.events.dendrogram_node_onclick(this.current_object_ids,this._unprefix(c),b)};InCHlib.prototype._column_dendrogram_layers_click=function(a,b){var c=b.target.attrs.path_id;a.fire("mouseout",a,b);this._highlight_column_cluster(c);this.events.column_dendrogram_node_onclick(this.current_column_ids,this._unprefix(c),b)};InCHlib.prototype._dendrogram_layers_mousedown=function(a,b){var c=this,d=b.target.attrs.path_id;clearTimeout(c.timer);
c.timer=setTimeout(function(){c._get_object_ids(d);c._zoom_cluster(d)},500)};InCHlib.prototype._column_dendrogram_layers_mousedown=function(a,b){var c=this,d=b.target.attrs.path_id;clearTimeout(c.timer);c.timer=setTimeout(function(){c._get_column_ids(d);c._zoom_column_cluster(d)},500)};InCHlib.prototype._dendrogram_layers_mouseup=function(a,b){clearTimeout(this.timer)};InCHlib.prototype._dendrogram_layers_mouseout=function(a,b){this.path_overlay.destroy();this.dendrogram_hover_layer.draw()};InCHlib.prototype._dendrogram_layers_mouseover=
function(a,b){this.path_overlay=b.target.attrs.path.clone({strokeWidth:4});this.dendrogram_hover_layer.add(this.path_overlay);this.dendrogram_hover_layer.draw()};InCHlib.prototype._visible_features_equal_column_dendrogram_count=function(){return this.on_features.data.length+this.on_features.metadata.length==this.current_column_count?!0:!1};InCHlib.prototype._get_color_for_value=function(a,b,c,d,e){var g=this.colors[e];e=g.start;var f=g.end;if(a>c)return"rgb("+f.r+","+f.g+","+f.b+")";if(b==c||a<b)return"rgb("+
e.r+","+e.g+","+e.b+")";void 0!==g.middle&&(a>=d?(b=d,e=g.middle,f=g.end):(c=d,e=g.start,f=g.middle));c=(a-b)/(c-b);a=this._hack_round(e.r+c*(f.r-e.r));b=this._hack_round(e.g+c*(f.g-e.g));e=this._hack_round(e.b+c*(f.b-e.b));return"rgb("+a+","+b+","+e+")"};InCHlib.prototype._get_font_size=function(a,b,c,d){var e=c-=2;e/2*a>b-10&&(e/=e/2*a/(b-10));e=e>c?c:e;return e>d?d:e};InCHlib.prototype._get_object_ids=function(a){this.current_object_ids=[];this._collect_object_ids(a)};InCHlib.prototype._collect_object_ids=
function(a){void 0!==this.data.nodes[a].left_child?(this._collect_object_ids(this.data.nodes[a].left_child),this._collect_object_ids(this.data.nodes[a].right_child)):this.current_object_ids.push.apply(this.current_object_ids,this.data.nodes[a].objects)};InCHlib.prototype._get_column_ids=function(a){this.current_column_ids=[];this._collect_column_ids(a);this.current_column_ids.sort(function(a,c){return a-c})};InCHlib.prototype._collect_column_ids=function(a){void 0!==this.column_dendrogram.nodes[a].left_child?
(this._collect_column_ids(this.column_dendrogram.nodes[a].left_child),this._collect_column_ids(this.column_dendrogram.nodes[a].right_child)):this.current_column_ids.push(this.nodes2columns[a])};InCHlib.prototype._hack_size=function(a){return Object.keys(a).length};InCHlib.prototype._hack_round=function(a){return.5+a>>0};InCHlib.prototype._is_number=function(a){return!isNaN(parseFloat(a))&&isFinite(a)};InCHlib.prototype._row_mouseenter=function(a){var b=a.target.parent.getAttr("id");this._get_visible_count();
if("column_metadata"!==a.target.parent.attrs.class){this.highlighted_row=b;var c=this.leaves_y_coordinates[b],d=this.heatmap_distance;this.row_overlay=this.objects_ref.heatmap_line.clone({points:[d,c,d+this.heatmap_width+this.dendrogram_heatmap_distance+this.settings.metadata_col_width*this.on_features.metadata.length,c],strokeWidth:this.pixels_for_leaf,stroke:"#FFFFFF",opacity:.3,listening:!1});this.heatmap_overlay.add(this.row_overlay);this.heatmap_overlay.draw();this.events.row_onmouseover(this.data.nodes[b].objects,
a)}};InCHlib.prototype._row_mouseleave=function(a){this.row_overlay.destroy();this.events.row_onmouseout(a)};InCHlib.prototype._draw_col_label=function(a){var b=a.target.attrs,c=b.points,d=this._hack_round((c[0]+c[2])/2),e=c[1]-.5*this.pixels_for_leaf,f=b.column.split("_"),h={d:this.heatmap_header[f[1]],m:this.metadata_header[f[1]],Count:"Count"};void 0!==this.column_metadata_header&&(h.cm=this.column_metadata_header[f[1]]);c=b.value;f=h[f[0]];f!==this.last_column&&"metadata"!==a.target.parent.attrs.class&&
(this.column_overlay.destroy(),this.last_column=b.column,this.column_overlay=this.objects_ref.heatmap_line.clone({points:[d,this.header_height,d,this.header_height+this.column_metadata_height+(this.heatmap_array.length+.5)*this.pixels_for_leaf],strokeWidth:this.pixels_for_dimension,stroke:"#FFFFFF",opacity:.3,listening:!1}),this.heatmap_overlay.add(this.column_overlay));void 0!==f&&(c=[f,c].join("\n"));a=this.objects_ref.tooltip_label.clone({x:d,y:e,id:"col_label"});a.add(this.objects_ref.tooltip_tag.clone({pointerDirection:"down"}),
this.objects_ref.tooltip_text.clone({text:c}));this.heatmap_overlay.add(a);this.heatmap_overlay.moveToTop();this.heatmap_overlay.draw()};InCHlib.prototype._unprefix=function(a){return a.split(this.settings.target+"#")[1]};InCHlib.prototype._prefix=function(a){return this.settings.target+"#"+a};InCHlib.prototype.get_features_for_object=function(a){return void 0!==this.objects2leaves[a]?this.data.nodes[this.objects2leaves[a]].features:!1};InCHlib.prototype.add_color_scale=function(a,b){this.colors[a]=
b;this.target_element.find(".color_scales").remove()};InCHlib.prototype._get_visible_count=function(){return this.on_features.data.length+this.on_features.count_column.length};InCHlib.prototype.update_settings=function(a){var b=this.settings.navigation_toggle;f.extend(this.settings,a);void 0!==a.navigation_toggle&&(this.settings.navigation_toggle=b,f.extend(this.settings.navigation_toggle,a.navigation_toggle))};InCHlib.prototype.redraw=function(){this._delete_all_layers();this.draw()};InCHlib.prototype.redraw_heatmap=
function(){this._delete_layers([this.heatmap_layer,this.heatmap_overlay,this.highlighted_rows_layer,this.header_layer]);this._set_color_settings();this._draw_heatmap();this._draw_heatmap_header();this.header_layer.moveToBottom();this.header_layer.moveUp();this.heatmap_layer.moveToBottom();this.heatmap_layer.moveUp();this.events.on_redraw_heatmap()}})(jQuery);
